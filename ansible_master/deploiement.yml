---
- name: DÃ©ploiement automatique depuis le Master
  hosts: Master
  gather_facts: false
  vars:
    remote_task_path: ~/task
    local_key_private: ~/.ssh/id_rsa_master
    local_key_public: ~/.ssh/id_rsa_master.pub

  tasks:

    - name: "ðŸ”· Ã‰tape 1 : CrÃ©er le dossier ~/task sur le Master"
      file:
        path: "{{ remote_task_path }}"
        state: directory
        mode: '0755'

    - name: "ðŸ”· Ã‰tape 2 : GÃ©nÃ©rer une paire de clÃ©s SSH si absente"
      shell: |
        if [[ ! -f ~/.ssh/id_rsa ]]; then
          ssh-keygen -t rsa -b 4096 -N "" -f ~/.ssh/id_rsa
        fi
      args:
        executable: /bin/bash

    - name: "ðŸ”· Ã‰tape 3 : Copier les fichiers hosts.ini et ansible.yml vers le Master"
      copy:
        src: "{{ item }}"
        dest: "{{ remote_task_path }}/"
      loop:
        - hosts.ini
        - ansible.yml

    - name: "ðŸ”· Ã‰tape 4 : CrÃ©er le rÃ©pertoire application/ cÃ´tÃ© Master (s'il n'existe pas)"
      file:
        path: "{{ remote_task_path }}/application/"
        state: directory
        mode: '0755'

    - name: "ðŸ”· Ã‰tape 5 : TransfÃ©rer le dossier application/ vers le Master"
      delegate_to: localhost
      shell: scp -r application/ ubuntu@{{ hostvars[inventory_hostname].ansible_host }}:{{ remote_task_path }}/
      args:
        executable: /bin/bash

    - name: "ðŸ”· Ã‰tape 6 : RÃ©cupÃ©rer la clÃ© privÃ©e du Master"
      fetch:
        src: ~/.ssh/id_rsa
        dest: "{{ local_key_private }}"
        flat: yes
        fail_on_missing: yes

    - name: "ðŸ”· Ã‰tape 7 : RÃ©cupÃ©rer la clÃ© publique du Master"
      fetch:
        src: ~/.ssh/id_rsa.pub
        dest: "{{ local_key_public }}"
        flat: yes
        fail_on_missing: yes

    - name: "ðŸ”· Ã‰tape 8 : Copier la clÃ© publique du Master vers tous les hÃ´tes"
      shell: ssh-copy-id -i {{ local_key_public }} -o StrictHostKeyChecking=no {{ hostvars[item].ansible_user | default('ubuntu') }}@{{ hostvars[item].ansible_host }}
      loop: "{{ groups['Application'] + groups['Pipeline'] + groups['Supervision'] }}"
      delegate_to: localhost
      ignore_errors: true

    - name: "ðŸ”· Ã‰tape 9 : Installer Ansible sur le Master si nÃ©cessaire"
      become: true
      shell: |
        if ! command -v ansible-playbook >/dev/null; then
          apt update -qq
          apt install -yqq software-properties-common
          add-apt-repository --yes --update ppa:ansible/ansible
          apt install -yqq ansible
        fi
      args:
        executable: /bin/bash

    - name: "ðŸ”· Ã‰tape 10 : Ajouter les known_hosts pour tous les hÃ´tes"
      shell: |
        grep ansible_host {{ remote_task_path }}/hosts.ini | sed -n 's/.*ansible_host=\([^ ]*\).*/\1/p' | xargs -n1 ssh-keyscan -H >> ~/.ssh/known_hosts
      args:
        executable: /bin/bash

    - name: "ðŸ”· Ã‰tape 11 : Nettoyage des clÃ©s SSH locales"
      delegate_to: localhost
      file:
        path: "{{ item }}"
        state: absent
      loop:
        - "{{ local_key_private }}"
        - "{{ local_key_public }}"
